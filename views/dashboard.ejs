<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - BuildOnBudget</title>
  <link href="/output.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="shortcut icon" href="/images/logo.png" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="/javascript/index.js"></script>
  <script src="/javascript/toast.js"></script>
  <script defer src="/javascript/dashboard.js"></script>
</head>

<body class="bg-bg-primary text-text-primary min-h-screen flex flex-col font-sans">

  <!-- HEADER -->
  <header class="bg-bg-secondary shadow-md sticky top-0 z-50">
    <div class="flex justify-between items-center px-4 py-3 md:px-8">
      <!-- Left: Menu + Brand -->
      <div class="flex items-center space-x-4">
        <button id="sidebar-toggle" class="md:hidden text-text-primary">
           <i class="fas fa-bars text-xl"></i>
        </button>
        <div class="flex items-center space-x-2">
          <img src="/images/logo.png" alt="Logo" class="w-8 h-8">
          <span class="text-lg font-bold text-purple-600">BuildOnBudget</span>
        </div>
      </div>
      <!-- Right: Actions -->
      <div class="flex items-center space-x-4">
        <button class="hidden sm:block bg-accent px-3 py-1 rounded-lg text-text-primary text-sm hover:opacity-90 transition cursor-pointer">
          <a href="/new-project">+ New Project</a>
        </button>
        <button id="profile-toggle" class="relative">
          <img src="<%= user.profile_image || 'https://picsum.photos/200/300/?blur=2' %>"
               class="w-10 h-10 rounded-full border-2 border-border object-cover">
        </button>
        <!-- Profile Dropdown -->
        <div id="profile-dropdown" class="absolute right-4 mt-60 w-48 bg-bg-secondary rounded-lg shadow-lg py-2 border border-border cursor-pointer hidden">
          <a href="/" class="block px-4 py-2 hover:bg-bg-primary">üè† Home</a>
          <a href="#settings" class="block px-4 py-2 hover:bg-bg-primary">‚öôÔ∏è Settings</a>
          <a href="#notifcations" class="block px-4 py-2 hover:bg-bg-primary">üîî Notifications</a>
          <a href="/logout" class="block px-4 py-2 hover:bg-bg-primary text-red-500">üö™ Logout</a>
        </div>
      </div>
    </div>
  </header>

  <div class="flex flex-1">

    <!-- MOBILE OVERLAY -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black/50 md:hidden z-40 hidden"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar"
      class="fixed md:static inset-y-0 left-0 w-72 bg-bg-secondary border-r border-bg-secondary z-50 transform transition-transform duration-300 md:translate-x-0 cursor-pointer">
        
      <div class="flex flex-col h-full">
       <!-- Sidebar Profile -->
        <div class="px-4 py-3 flex items-center space-x-3">
          <img src="<%= user.profile_image || 'https://picsum.photos/200/300/?blur=2' %>" 
               class="w-12 h-12 rounded-full border-2 border-border object-cover">
          <div>
            <p class="font-semibold"><%= user.name %></p>
            <p class="text-sm text-text-secondary"><%= user.email %></p>
          </div>
        </div>

        <!-- Nav Links -->
        <nav class="flex-1 overflow-y-auto px-4 py-6">
          <ul class="space-y-2">
            <li>
              <button data-tab="dashboard" class="tab-button w-full flex items-center px-4 py-2 rounded-lg transition cursor-pointer bg-accent text-text-primary">
                <i class="fas fa-home w-6 text-center mr-3"></i>
                <span>Dashboard</span>
              </button>
            </li>
            <li>
              <button data-tab="projects" class="tab-button w-full flex items-center px-4 py-2 rounded-lg transition cursor-pointer hover:bg-bg-primary">
                <i class="fas fa-folder-open w-6 text-center mr-3"></i>
                <span>Projects</span>
              </button>
            </li>
            <li>
              <button data-tab="tasks" class="tab-button w-full flex items-center px-4 py-2 rounded-lg transition cursor-pointer hover:bg-bg-primary">
                <i class="fas fa-list-check w-6 text-center mr-3"></i>
                <span>Tasks</span>
              </button>
            </li>
            <li>
              <button data-tab="budget" class="tab-button w-full flex items-center px-4 py-2 rounded-lg transition cursor-pointer hover:bg-bg-primary">
                <i class="fas fa-wallet w-6 text-center mr-3"></i>
                <span>Budget</span>
              </button>
            </li>
            <li>
              <button data-tab="teams" class="tab-button w-full flex items-center px-4 py-2 rounded-lg transition cursor-pointer hover:bg-bg-primary">
                <i class="fas fa-users w-6 text-center mr-3"></i>
                <span>Teams</span>
              </button>
            </li>
            <li>
              <button data-tab="shop" class="tab-button w-full flex items-center px-4 py-2 rounded-lg transition cursor-pointer hover:bg-bg-primary">
                <i class="fas fa-shopping-cart w-6 text-center mr-3"></i>
                <span>Shop</span>
              </button>
            </li>
            <li>
              <button data-tab="settings" class="tab-button w-full flex items-center px-4 py-2 rounded-lg transition cursor-pointer hover:bg-bg-primary">
                <i class="fas fa-gear w-6 text-center mr-3"></i>
                <span>Settings</span>
              </button>
            </li>
            <li>
              <button data-tab="notifications" class="tab-button w-full flex items-center px-4 py-2 rounded-lg transition cursor-pointer hover:bg-bg-primary">
                <i class="fas fa-bell w-6 text-center mr-3"></i>
                <span>Notifications<% if (pendingNotifications > 0) { %> (<%= pendingNotifications %>)<% } %></span>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 p-4 md:p-8 space-y-8 overflow-y-auto">

      <!-- Dashboard Tab -->
      <div id="tab-dashboard" class="tab-content space-y-6">
        <h2 class="text-3xl font-bold">üëã Welcome back, <%= user.name %>!</h2>
        <p class="text-text-secondary">Here‚Äôs an overview of your progress today.</p>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-bg-secondary rounded-xl p-6 shadow hover:shadow-lg transition">
            <p class="text-sm text-text-secondary">Active Projects</p>
            <h3 class="text-2xl font-bold"><%= activeProjects %></h3>
          </div>
          <div class="bg-bg-secondary rounded-xl p-6 shadow hover:shadow-lg transition">
            <p class="text-sm text-text-secondary">Tasks Due</p>
            <h3 class="text-2xl font-bold"><%= tasksDue %></h3>
          </div>
          <div class="bg-bg-secondary rounded-xl p-6 shadow hover:shadow-lg transition">
            <p class="text-sm text-text-secondary">Budget Spent</p>
            <h3 class="text-2xl font-bold">$<%= budgetSpent.toFixed(2) %></h3>
          </div>
          <div class="bg-bg-secondary rounded-xl p-6 shadow hover:shadow-lg transition">
            <p class="text-sm text-text-secondary">Team Members</p>
            <h3 class="text-2xl font-bold"><%= teamMembers %></h3>
          </div>
        </div>

        <!-- Charts and Analysis -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
          <!-- Task Status Bar Chart -->
          <div class="bg-bg-secondary rounded-xl p-6 shadow hover:shadow-lg transition">
            <h4 class="text-lg font-semibold mb-4">Task Status Overview</h4>
            <canvas id="taskStatusChart" width="400" height="200" data-pending="<%= taskStatusCounts.pending %>" data-in-progress="<%= taskStatusCounts.in_progress %>" data-completed="<%= taskStatusCounts.completed %>"></canvas>
          </div>

          <!-- Monthly Tasks Completed -->
          <div class="bg-bg-secondary rounded-xl p-6 shadow hover:shadow-lg transition">
            <h4 class="text-lg font-semibold mb-4">Monthly Tasks Completed</h4>
            <canvas id="monthlyTasksChart" width="400" height="200" data-labels="<%= JSON.stringify(monthlyTasksLabels) %>" data-data="<%= JSON.stringify(monthlyTasksData) %>"></canvas>
          </div>

          <!-- Project Progress -->
          <div class="bg-bg-secondary rounded-xl p-6 shadow hover:shadow-lg transition">
            <h4 class="text-lg font-semibold mb-4">Project Completion</h4>
            <% projects.slice(0, 5).forEach(project => { %>
              <% const completed = project.tasks.filter(t => t.status === 'completed').length; %>
              <% const total = project.tasks.length; %>
              <% const progress = total > 0 ? Math.round((completed / total) * 100) : 0; %>
              <div class="mb-4">
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm font-medium"><%= project.name %></span>
                  <span class="text-sm text-text-secondary"><%= progress %>%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-accent h-2 rounded-full" style="width: <%= progress %>%;"></div>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      </div>

      <!-- Other Tabs (Projects, Tasks, Budget, Teams, Settings, etc.) -->
      <div id="tab-projects" class="tab-content space-y-6 hidden">
        <h3 class="text-2xl font-bold">üìÅ Projects</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <% if (projects && projects.length > 0) { %>
            <% projects.forEach(project => { %>
              <div class="bg-bg-secondary rounded-lg p-5 shadow hover:shadow-lg transition">
                <h4 class="text-lg font-semibold mb-2"><%= project.name %></h4>
                <p class="text-text-secondary mb-3 line-clamp-2"><%= project.description %></p>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-text-secondary">Budget: $<%= project.budget %></span>
                  <a href="/dashboard/<%= project.id %>" class="text-purple-600 font-medium hover:underline">View</a>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-text-primary">No projects yet. Click ‚Äú+ New Project‚Äù to get started.</p>
          <% } %>
        </div>
      </div>

      <!-- Example placeholder for other tabs -->
      <div id="tab-tasks" class="tab-content bg-bg-secondary rounded-xl p-6 shadow hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">üìù Tasks</h3>
          <button class="bg-accent px-3 py-1 rounded-lg text-white text-sm hover:opacity-90 transition cursor-pointer">
            <a href="/new-task">+ New Task</a>
          </button>
        </div>
        <div class="space-y-4">
          <% projects.forEach(project => { %>
            <div class="border border-border rounded-lg p-4">
            <div class="flex justify-between items-center cursor-pointer project-toggle" data-project="<%= project.id %>">
              <h4 class="text-lg font-semibold"><%= project.name %></h4>
              <span class="text-accent project-indicator">+</span>
            </div>
            <div class="project-tasks mt-4 space-y-2 hidden" data-project="<%= project.id %>">
              <% project.tasks.forEach(task => { %>
                <div class="flex justify-between items-center bg-bg-primary p-2 rounded">
                  <div>
                    <p class="font-medium"><%= task.name %></p>
                    <p class="text-sm text-text-secondary">Status: <%= task.status %></p>
                  </div>
                  <div class="flex space-x-2">
                    <button class="text-blue-500 hover:underline" onclick="editTask('<%= task.id %>')">Edit</button>
                    <button class="text-green-500 hover:underline" onclick="markDone('<%= task.id %>', this)">Done</button>
                    <button class="text-red-500 hover:underline" onclick="deleteTask('<%= task.id %>', this)">Delete</button>
                  </div>
                </div>
              <% }) %>
              <% if (project.tasks.length === 0) { %>
                <p class="text-text-secondary">No tasks yet.</p>
              <% } %>
            </div>
            </div>
          <% }) %>
        </div>
      </div>

      <div id="tab-budget" class="tab-content bg-bg-secondary rounded-xl p-6 shadow hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">üí∞ Budget</h3>
          <button class="bg-accent px-3 py-1 rounded-lg text-white text-sm hover:opacity-90 transition cursor-pointer">
            <a href="/budget">+ New Budget</a>
          </button>
        </div>
        <div class="space-y-4">
          <% projects.forEach(project => { %>
            <div class="border border-border rounded-lg p-4">
              <div class="flex justify-between items-center cursor-pointer budget-toggle" data-project="<%= project.id %>">
                <h4 class="text-lg font-semibold"><%= project.name %></h4>
                <span class="text-accent budget-indicator">+</span>
              </div>
              <div class="project-budgets mt-4 space-y-2 hidden" data-project="<%= project.id %>">
                <% const projectBudgets = budgets.filter(b => b.project_id === project.id); %>
                <% if (projectBudgets.length > 0) { %>
                  <% projectBudgets.forEach(budget => { %>
                    <div class="bg-bg-primary p-4 rounded">
                      <div class="flex justify-between items-center mb-2">
                        <p class="font-medium">Total Budget: $<%= budget.totalBudget %></p>
                        <div class="flex space-x-2">
                          <button class="text-blue-500 hover:underline" onclick="editBudget('<%= budget.id %>')">Edit</button>
                          <button class="text-red-500 hover:underline" onclick="deleteBudget('<%= budget.id %>', this)">Delete</button>
                        </div>
                      </div>
                      <%
                        let components = [];
                        try {
                          components = JSON.parse(budget.components);
                        } catch (e) {
                          components = [];
                        }
                      %>
                      <div class="mb-2">
                        <p class="text-sm font-medium">Components:</p>
                        <ul class="list-disc list-inside text-sm">
                          <% components.forEach(component => { %>
                            <li><%= component.name %>: $<%= component.cost %></li>
                          <% }) %>
                        </ul>
                      </div>
                      <% const allocated = components.reduce((sum, comp) => sum + parseFloat(comp.cost || 0), 0); %>
                      <% const total = parseFloat(budget.totalBudget || 0); %>
                      <% const difference = allocated - total; %>
                      <p class="text-sm">
                        Allocated: $<%= allocated.toFixed(2) %> / $<%= total.toFixed(2) %>
                        <% if (difference === 0) { %>
                          <span class="text-green-600">(Perfectly allocated)</span>
                        <% } else if (difference > 0) { %>
                          <span class="text-red-600">(Overallocated by $<%= difference.toFixed(2) %>)</span>
                        <% } else { %>
                          <span class="text-yellow-600">(Underallocated by $<%= Math.abs(difference).toFixed(2) %>)</span>
                        <% } %>
                      </p>
                    </div>
                  <% }) %>
                <% } else { %>
                  <p class="text-text-secondary">No budget yet.</p>
                <% } %>
              </div>
            </div>
          <% }) %>
        </div>
      </div>

      <div id="tab-shop" class="tab-content bg-bg-secondary rounded-xl p-6 shadow hidden">
        <h3 class="text-2xl font-bold">üõí Shop</h3>
        <p class="text-text-secondary mb-4">Browse and purchase construction materials.</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
          <% if (shopItems && shopItems.length > 0) { %>
            <% shopItems.forEach(item => { %>
              <div class="bg-bg-primary rounded-lg p-4 shadow hover:shadow-lg transition">
          <img src="<%= item.media ? item.media.url : '/images/logo.png' %>" alt="<%= item.name %>" class="w-full h-32 object-cover rounded mb-2">
                <h4 class="text-lg font-semibold mb-1"><%= item.name %></h4>
                <p class="text-text-secondary text-sm mb-2 line-clamp-2"><%= item.description || 'High-quality construction material' %></p>
                <p class="text-lg font-bold text-accent">$<%= parseFloat(item.price).toFixed(2) %></p>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-text-secondary">No items available.</p>
          <% } %>
        </div>
        <div class="flex justify-center">
          <a href="/shop" class="bg-accent px-6 py-2 rounded text-text-primary hover:bg-accent/90 transition">See More</a>
        </div>
      </div>

      <div id="tab-teams" class="tab-content bg-bg-secondary rounded-xl p-6 shadow hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">üë• Teams</h3>
          <button class="bg-accent px-3 py-1 rounded-lg text-white text-sm hover:opacity-90 transition cursor-pointer">
            <a href="/invite-member">+ Invite Team Member</a>
          </button>
        </div>

        <div class="mb-6">
          <h4 class="text-lg font-semibold mb-4">Teams by You</h4>
          <% projects.forEach(project => { %>
            <div class="border border-border rounded-lg p-4 mb-4">
              <div class="flex justify-between items-center cursor-pointer team-by-you-toggle" data-project="<%= project.id %>">
                <h4 class="text-lg font-semibold"><%= project.name %></h4>
                <span class="text-accent team-by-you-indicator">+</span>
              </div>
              <div class="project-teams-by-you mt-4 space-y-2 hidden" data-project="<%= project.id %>">
                <% const projectTeams = teamsByYou.filter(t => t.project_id && t.project_id.id === project.id); %>
                <% if (projectTeams.length > 0) { %>
                  <% projectTeams.forEach(team => { %>
                    <div class="bg-bg-primary p-4 rounded">
                      <p class="font-medium mb-1"><strong>Email:</strong> <%= team.email %></p>
                      <p class="text-text-secondary mb-1"><strong>Role:</strong> <%= team.role %></p>
                      <p class="text-text-secondary"><strong>Status:</strong> <%= team.status %></p>
                    </div>
                  <% }) %>
                <% } else { %>
                  <p class="text-text-secondary">No team members invited yet.</p>
                <% } %>
              </div>
            </div>
          <% }) %>
        </div>

        <div>
          <h4 class="text-lg font-semibold mb-4">Teams Invited To</h4>
          <%
            const groupedInvitedTo = {};
            teamsInvitedTo.forEach(team => {
              if (team.project_id) {
                const projectId = team.project_id.id;
                if (!groupedInvitedTo[projectId]) {
                  groupedInvitedTo[projectId] = { project: team.project_id, teams: [] };
                }
                groupedInvitedTo[projectId].teams.push(team);
              }
            });
            const invitedToProjects = Object.values(groupedInvitedTo);
          %>
          <% if (invitedToProjects.length > 0) { %>
            <% invitedToProjects.forEach(group => { %>
              <div class="border border-border rounded-lg p-4 mb-4">
                <div class="flex justify-between items-center cursor-pointer team-invited-to-toggle" data-project="<%= group.project.id %>">
                  <h4 class="text-lg font-semibold"><%= group.project.name %></h4>
                  <span class="text-accent team-invited-to-indicator">+</span>
                </div>
                <div class="project-teams-invited-to mt-4 space-y-2 hidden" data-project="<%= group.project.id %>">
                  <% group.teams.forEach(team => { %>
                    <div class="bg-bg-primary p-4 rounded">
                      <p class="text-text-secondary mb-1"><strong>Role:</strong> <%= team.role %></p>
                      <p class="text-text-secondary"><strong>Status:</strong> <%= team.status %></p>
                    </div>
                  <% }) %>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-text-secondary">No invitations received yet.</p>
          <% } %>
        </div>
      </div>

      <div id="tab-settings" class="tab-content bg-bg-secondary rounded-xl shadow hidden">
        <!-- Cover Photo -->
         <div class="relative mb-16">
         <img id="cover-photo" src="<%= user.profile_image || 'https://picsum.photos/800/400/?blur=2' %>" alt="Cover Photo" class="w-full object-cover rounded-t-xl" style="max-height: 200px;" />
          <!-- Profile Image Overlay -->
          <img id="profile-image" src="<%= user.profile_image || 'https://picsum.photos/200/200/?blur=2' %>" alt="Profile Image" class="w-24 h-24 rounded-full object-cover border-4 border-bg-secondary absolute bottom-0 left-6 transform translate-y-1/2" />
        </div>

        <!-- User Details -->
        <div class="pt-16 px-6 pb-6">
          <h3 class="text-xl font-bold mb-6">‚öôÔ∏è Settings</h3>
          <form id="user-details-form" class="space-y-4">
            <div>
              <label for="name" class="block mb-1 font-medium">Name</label>
              <input type="text" id="name" name="name" value="<%= user.name %>" required
                class="w-full border border-border px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-accent" />
            </div>
            <div>
              <label for="email" class="block mb-1 font-medium">Email (Cannot be changed)</label>
              <input type="email" id="email" name="email" value="<%= user.email %>" readonly
                class="w-full border border-border px-4 py-2 rounded-md cursor-not-allowed" />
            </div>
            <div>
              <label for="phone" class="block mb-1 font-medium">Phone</label>
              <input type="tel" id="phone" name="phone" value="<%= user.phone || '' %>"
                class="w-full border border-border px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-accent" />
            </div>
            <button type="submit" class="bg-accent text-white px-4 py-2 rounded-md hover:bg-accent/90 transition">
              Update Details
            </button>
          </form>
        </div>

        <!-- Preferences -->
        <div>
          <h4 class="text-lg font-semibold mb-4">Preferences</h4>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <span>Verify Email</span>
              <button id="verify-email" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">
                Verify
              </button>
            </div>
            <div class="flex items-center justify-between">
              <span>Verify Phone</span>
              <button id="verify-phone" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">
                Verify
              </button>
            </div>
            <div class="flex items-center justify-between">
              <span>Theme</span>
              <button id="theme-toggle" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 transition">
                Toggle Dark/Light
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="tab-notifications" class="tab-content bg-bg-secondary rounded-xl p-6 shadow hidden">
        <h3 class="text-xl font-bold mb-4">üîî Notifications</h3>
        <% if (teamsInvitedTo && teamsInvitedTo.length > 0) { %>
          <div class="space-y-4">
            <% teamsInvitedTo.forEach(team => { %>
              <div class="bg-bg-primary p-4 rounded-lg border <%= team.status === 'pending' ? 'border-yellow-500 bg-yellow-50' : 'border-border' %>">
                <div class="flex justify-between items-center">
                  <div>
                    <p class="font-medium"><%= team.project_id ? team.project_id.name : 'Unknown Project' %></p>
                    <p class="text-sm text-text-secondary">Role: <%= team.role %></p>
                    <p class="text-sm text-text-secondary">Status: <span class="<%= team.status === 'pending' ? 'text-yellow-600 font-semibold' : team.status === 'accepted' ? 'text-green-600' : 'text-red-600' %>"><%= team.status %></span></p>
                  </div>
                  <% if (team.status === 'pending') { %>
                    <button onclick="acceptInvite('<%= team.id %>')" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition">
                      Accept
                    </button>
                  <% } %>
                </div>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <p class="text-text-secondary">No notifications.</p>
        <% } %>
      </div>

    </main>
  </div>

  <!-- FOOTER -->
  <footer class="bg-bg-secondary text-text-secondary text-center py-4 border-t border-border">
    &copy; <%= new Date().getFullYear() %> BuildOnBudget. All rights reserved.
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // User Details Form
      document.getElementById('user-details-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        // Remove email since not editable
        delete data.email;

        try {
          const response = await fetch('/update-user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
          const result = await response.json();
          if (response.ok) {
            showToast('Details updated successfully', 'success');
            setTimeout(() => location.reload(), 1000);
          } else {
            showToast(result.error || 'Error updating details', 'error');
          }
        } catch (error) {
          console.error('Error:', error);
          showToast('An error occurred', 'error');
        }
      });

      // Generate Random Images if none
      const coverPhoto = document.getElementById('cover-photo');
      const profileImage = document.getElementById('profile-image');
      if (coverPhoto.src.includes('picsum.photos') && coverPhoto.src.includes('blur=2') && !coverPhoto.src.includes('random=')) {
        const randomCover = 'https://picsum.photos/800/400/?blur=2&random=' + Math.random();
        coverPhoto.src = randomCover;
      }
      if (profileImage.src.includes('picsum.photos') && profileImage.src.includes('blur=2') && !profileImage.src.includes('random=')) {
        const randomProfile = 'https://picsum.photos/200/200/?blur=2&random=' + Math.random();
        profileImage.src = randomProfile;
      }

      // Verify Email
      document.getElementById('verify-email').addEventListener('click', function() {
        showToast('Verification email sent', 'success');
      });

      // Verify Phone
      document.getElementById('verify-phone').addEventListener('click', function() {
        showToast('Verification SMS sent', 'success');
      });

      // Theme Toggle
      const themeToggle = document.getElementById('theme-toggle');
      const html = document.documentElement;
      const currentTheme = localStorage.getItem('theme') || 'light';
      if (currentTheme === 'dark') {
        html.classList.add('dark');
        themeToggle.textContent = 'Switch to Light';
      } else {
        themeToggle.textContent = 'Switch to Dark';
      }

      themeToggle.addEventListener('click', function() {
        if (html.classList.contains('dark')) {
          html.classList.remove('dark');
          localStorage.setItem('theme', 'light');
          themeToggle.textContent = 'Switch to Dark';
        } else {
          html.classList.add('dark');
          localStorage.setItem('theme', 'dark');
          themeToggle.textContent = 'Switch to Light';
        }
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Task Status Bar Chart
      const canvas1 = document.getElementById('taskStatusChart');
      const ctx1 = canvas1.getContext('2d');
      const data1 = {
        labels: ['Pending', 'In Progress', 'Completed'],
        datasets: [{
          label: 'Tasks',
          data: [parseInt(canvas1.dataset.pending), parseInt(canvas1.dataset.inProgress), parseInt(canvas1.dataset.completed)],
          backgroundColor: ['#ff6384', '#36a2eb', '#cc65fe'],
          borderColor: ['#ff6384', '#36a2eb', '#cc65fe'],
          borderWidth: 1
        }]
      };
      new Chart(ctx1, {
        type: 'bar',
        data: data1,
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Monthly Tasks Completed Bar Chart
      const canvas2 = document.getElementById('monthlyTasksChart');
      const ctx2 = canvas2.getContext('2d');
      const data2 = {
        labels: JSON.parse(canvas2.dataset.labels),
        datasets: [{
          label: 'Completed Tasks',
          data: JSON.parse(canvas2.dataset.data),
          backgroundColor: '#36a2eb',
          borderColor: '#36a2eb',
          borderWidth: 1
        }]
      };
      new Chart(ctx2, {
        type: 'bar',
        data: data2,
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    });
  </script>
</body>
</html>
